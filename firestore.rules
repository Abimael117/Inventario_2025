/**
 * @description This ruleset enforces a public read, owner-write model for Products and Loans.
 * All data is stored in top-level collections: /products/{productId} and /loans/{loanId}.
 * Key Security Decisions:
 *   - Unauthenticated (anonymous) users can read all product and loan data.
 *   - Only authenticated users can create, update, or delete product and loan data.
 *   - An 'ownerId' field (or similar) must be added to the Product and Loan entities to enable write permissions.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    /**
     * @description Allows public read access to products and restricts write access to authenticated owners.
     * @path /products/{productId}
     * @allow (get, list): Any unauthenticated user can read product data.
     * @allow (create): Only an authenticated user can create a product, with the 'ownerId' matching their UID.
     * @allow (update, delete): Only the authenticated owner of the product can modify or delete it.
     * @deny (create): Unauthenticated users cannot create products.
     * @deny (update, delete): Unauthenticated users cannot modify or delete products.
     * @principle Public read, owner-only writes. Requires 'ownerId' field in the Product entity.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.keys().hasAll(['name', 'sku', 'category', 'quantity', 'location', 'reorderPoint']) ;
      allow update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to loans and restricts write access to authenticated owners.
     * @path /loans/{loanId}
     * @allow (get, list): Any unauthenticated user can read loan data.
     * @allow (create): Only an authenticated user can create a loan, with the 'ownerId' matching their UID.
     * @allow (update, delete): Only the authenticated owner of the loan can modify or delete it.
     * @deny (create): Unauthenticated users cannot create loans.
     * @deny (update, delete): Unauthenticated users cannot modify or delete loans.
     * @principle Public read, owner-only writes. Requires 'ownerId' field in the Loan entity.
     */
    match /loans/{loanId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.keys().hasAll(['productName', 'requester', 'loanDate', 'status']) ;
      allow update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}