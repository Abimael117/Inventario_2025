/**
 * @file Firestore Security Rules
 * @version 2
 *
 * @description
 * This ruleset enforces access control based on user authentication and roles.
 *
 * Data Structure:
 * - /products/{productId}: Stores product inventory information.
 * - /loans/{loanId}: Stores product loan records.
 * - /users/{userId}: Stores user-specific data, including their role.
 *
 * Key Security Decisions:
 * - All collections require user to be authenticated for any access.
 * - The 'users' collection is read-only for clients, except for admins who can write.
 *   A user can only read their own data.
 * - Write access to 'products' and 'loans' is restricted to authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to get the user's role from the 'users' collection.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // Helper function to check if the requesting user is an admin.
    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    /**
     * @description Access to user data is restricted.
     * @path /users/{userId}
     * @allow (get): A user can only read their own profile.
     * @allow (list): Listing users is forbidden to prevent leaking user information.
     * @allow (write): Only admins can create or update user documents.
     * @allow (delete): No one can delete user profiles from the client-side.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if false;
      allow write: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Requires authentication for all access to products.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Requires authentication for all access to loans.
     * @path /loans/{loanId}
     */
    match /loans/{loanId} {
      allow read, write: if isSignedIn();
    }
  }
}
